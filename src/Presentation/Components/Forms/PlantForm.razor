@using Core.Dtos
@using Core.Enums
@using Core.Interface.Services

@inject IPlantImageService ImageService

<EditForm Model="Model">

    <div class="form-container">
        <label class="form-label">Name</label>
        <InputText class="form-control" @bind-Value="Model.Name"/>    
    </div>    

    <div class="form-container">
        <label class="form-label">Species</label>
        <InputText class="form-control" @bind-Value="Model.Species"/>    
    </div>  

    <div class="form-container">
        <label class="form-label">Location</label>
        <InputText class="form-control" @bind-Value="Model.Location"/>    
    </div>  

    <div class="form-container">
        <label class="form-label">Water Frequency</label>
        <InputSelect class="form-select" @bind-value="Model.WaterFrequency">  
            @foreach(var frequency in Enum.GetValues<WaterFrequency>())
            {
                <option value="@frequency">@frequency</option>
            }  
        </InputSelect>
    </div> 
    <div class="form-container">
        <label class="form-label">Last Watered</label>
        <InputDate class="form-control" @bind-Value="Model.LastWatered"/>    
    </div>   

    <div class="form-container">
        <label class="form-label">Plant Image</label>
        <InputFile OnChange="HandleFileSelected" accept="image/*" />
        @if (!string.IsNullOrEmpty(uploadedImage?.Name))
        {
            <p class="form-hint">Selected file: @uploadedImage.Name</p>
        }
    </div>

    <button class="plant-btn plant-btn-save" @onclick="HandleSave">Save</button>
    <button class="plant-btn plant-btn-cancel" @onclick="HandleCancel">Cancel</button>

</EditForm>

@code 
{
    [Parameter]
    public PlantFormModel Model { get; set; } = default!;

    [Parameter]
    public EventCallback OnValidSubmit { get; set; }
    
    [Parameter]
    public EventCallback OnCancel { get; set; }

    private IBrowserFile? uploadedImage;
    private const long MaxFileSize = 5 * 1024 * 1024;

    public async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedImage = e.File;
        await HandleFileUrl();
    }

    public async Task HandleFileUrl()
    {
        if (uploadedImage != null)
        {
            await using var stream = uploadedImage.OpenReadStream(MaxFileSize);

            var imageUrl = await ImageService.SavePlantImageAsync(stream, uploadedImage.Name, uploadedImage.ContentType, default);

            Model.ImageUrl = imageUrl;
        }
    }

    public async Task HandleSave()
    {
        if (OnValidSubmit.HasDelegate)
        {
            await OnValidSubmit.InvokeAsync();
        }
    }
    public async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }
}
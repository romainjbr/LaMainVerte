@page "/dashboard"

@using Core.Dtos
@using Core.Enums
@using Core.Interface.Services
@using Presentation.Components.Cards

@inject IPlantService PlantService
@inject IWateringLogService WateringLogService
@inject NavigationManager NavigationManager

<div class="dash-header">
    <div class="dash-header_left">
        <h1 class="dash-title">Dashboard</h1>
        <p class="dash-subtitle">Overview of your plants and watering activity. </p>
    </div>

    <div class="dash-header_right">
        <div class="dash-tag">Today • @today.ToString("D")</div>
    </div>
</div>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row mb-4 dash-metrics">
        <div class="col-md-3 mb-3">
            <div class="metric-card">
                <div class="metric-card_label">Total plants</div>
                <div class="metric-card_value">@plantsCount</div>
                <button class="metric-card_link" @onclick="NavigateBackToPlants">View plants →</button>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="metric-card">
                <div class="metric-card_label">Needing water</div>
                <div class="metric-card_value">@plantsNeedingWaterCount</div>

                @if (plantsNeedingWaterCount > 0)
                {
                    <ul class="metric-card_list">
                        @foreach (var plant in plantsNeedingWater.Take(3))
                        {
                            <li>@plant.Name</li>
                        }
                    </ul>
                }
                else
                {
                    <p class="metric-card_hint">All plants are watered!</p>
                }
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="metric-card">
                <div class="metric-card_label">Watered this week</div>
                <div class="metric-card_value">@wateredThisWeek</div>
                <p class="metric-card_hint">Waterings in the last 7 days.</p>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="metric-card">
                <div class="metric-card_label">Weekly watering load</div>
                <div class="metric-card_value">@weeklyWateringLoad.ToString("0.#")</div>
                <p class="metric-card_hint">Estimated waterings per week:</p>
            </div>
        </div>
    </div>

    <div class="row mb-4">

    </div>
}


@code {
    private bool isLoading = true;
    private DateTime today = DateTime.Today;

    private List<PlantReadDto> plantsNeedingWater = new();
    private int plantsNeedingWaterCount;

    private List<WateringLogReadDto> recentWateringLogs = new();

    private List<PlantReadDto> plants = new();
    private int plantsCount;

    private int wateredThisWeek;
    private double weeklyWateringLoad;

    protected override async Task OnInitializedAsync()
    {
        plants = await PlantService.GetAllPlantsAsync(default);
        plantsCount = plants.Count;

        await InitializePlantsNeedingWater();
        await InitializeWateringLogsData();

        isLoading = false;
    }

    private async Task InitializePlantsNeedingWater()
    {
        plantsNeedingWater = await PlantService.GetPlantsNeedingWater(default);
        plantsNeedingWaterCount = plantsNeedingWater.Count;      
    }

    private async Task InitializeWateringLogsData()
    {
        recentWateringLogs = await WateringLogService.GetRecentAsync(100, default);

        var weekStart = today.AddDays(-7);
        wateredThisWeek = recentWateringLogs.Count(l => l.Date.Date >= weekStart);

        weeklyWateringLoad = plants.Sum(p => p.WaterFrequency.GetWeeklyWaterings());       
    }

    public void NavigateBackToPlants()
    {
        NavigationManager.NavigateTo("/plants");
    }
}

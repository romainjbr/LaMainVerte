@page "/plants/edit/{id:guid}"
@using Core.Dtos
@using Core.Enums
@using Core.Interface.Services
@using Presentation.Components.Forms

@inject IPlantService Service
@inject NavigationManager NavigationManager

<div class="plant-form-page">
    @if (isLoading)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="plant-form-header">
            <button class="plant-back-link" @onclick="NavigateBackToPlants">‚Üê Back to plants</button>

            <div>
                <h1 class="plant-form-title">Edit plant</h1>
                <p class="plant-form-subtitle">@plant.Name</p>
            </div>
        </div>

        <div class="plant-form-card">
            <PlantForm Model="plant"
            OnValidSubmit="HandleSubmit"
            OnCancel="HandleCancel"/>
        </div>
    }
</div>


@code 
{
    private PlantFormModel plant;
    private bool isLoading = true;

    [Parameter]
    public Guid Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var dto = await Service.GetPlantByIdAsync(Id, default);

        plant = new PlantFormModel
        {
            Name = dto?.Name ?? string.Empty,
            Species = dto?.Species ?? string.Empty,
            Location = dto?.Location ?? string.Empty,
            LastWatered = dto?.LastWatered,
            WaterFrequency = dto?.WaterFrequency ?? default,
            ImageUrl = dto?.ImageUrl ?? string.Empty
        };

        isLoading = false;
    }

    public void NavigateBackToPlants()
    {
        NavigationManager.NavigateTo("/plants");
    }

    public void HandleSubmit()
    {  
        if (plant is null) { return; }

        var dto = new PlantUpdateDto(
            plant.Id,
            plant.Name, 
            plant.Species, 
            plant.Location,
            plant.LastWatered ?? default,
            plant.WaterFrequency,
            plant.WateringLogs,
            plant.ImageUrl
        );

        Service.UpdatePlantAsync(dto, default);
        NavigateBackToPlants();      
    }

    public void HandleCancel()
    {        
        plant = new();
        NavigateBackToPlants();
    }
}